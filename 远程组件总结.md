# 远程组件方案分析
## 模块联邦
号称最成熟的方案，按远程应用的名字往 window 注入对象，对象里包含依赖和组件
应用使用这个对象里的依赖和组件
### 组件应用
#### 配置
```js
// project-a/vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import federation from '@originjs/vite-plugin-federation'

export default defineConfig({
  plugins: [
    vue(),
    federation({
      // 远程应用名称
      name: 'componentLibraryA',
      // 生成的入口文件名
      filename: 'remoteEntry.js',
      // 暴露的模块
      exposes: {
        './Button': './src/components/Button/index.vue',
        './Table': './src/components/Table/index.vue',
        './Form': './src/components/Form/index.vue',
        // 也可以暴露工具函数
        './utils': './src/utils/index.ts'
      },
      // 共享依赖配置 - 这是关键！
      shared: {
        'vue': {
          // 单例模式，确保只有一个Vue实例
          singleton: true,
          // 严格版本要求
          strictVersion: true,
          // 必需的版本
          requiredVersion: '^3.3.0',
          // 渴望加载(优先使用共享版本)
          eager: false
        },
        'element-plus': {
          singleton: true,
          requiredVersion: '^2.4.0',
          eager: false
        },
        'axios': {
          singleton: true,
          requiredVersion: '^1.5.0',
          eager: false
        }
      }
    })
  ],

  build: {
    // 目标ES版本
    target: 'esnext',
    // 不压缩，便于调试
    minify: false,
    rollupOptions: {
      // 外部化共享依赖
      external: ['vue', 'element-plus', 'axios'],
      output: {
        // 输出格式
        format: 'esm',
        // 全局变量映射
        globals: {
          'vue': 'Vue',
          'element-plus': 'ElementPlus',
          'axios': 'axios'
        }
      }
    }
  },
  // 开发服务器配置
  server: {
    port: 3001,
    cors: true
  }
})
```
#### 产物示例
```js
// dist/remoteEntry.js
(function() {
  'use strict';

  // 模块映射表 - 每个暴露的模块都有对应的加载函数
  const moduleMap = {
    './Button': () => {
      return import('./assets/Button-a1b2c3d4.js');
    },
    './Table': () => {
      return import('./assets/Table-e5f6g7h8.js');
    },
    './Form': () => {
      return import('./assets/Form-i9j0k1l2.js');
    },
    './utils': () => {
      return import('./assets/utils-m3n4o5p6.js');
    }
  };

  // 共享依赖配置
  const sharedConfig = {
    'vue': {
      '3.3.4': {
        get: () => import('./shared/vue-shared-chunk.js'),
        loaded: 1,
        eager: false,
        singleton: true
      }
    },
    'element-plus': {
      '2.4.0': {
        get: () => import('./shared/element-plus-shared-chunk.js'),
        loaded: 1,
        eager: false,
        singleton: true
      }
    },
    'axios': {
      '1.5.0': {
        get: () => import('./shared/axios-shared-chunk.js'),
        loaded: 1,
        eager: false,
        singleton: true
      }
    }
  };

  // 共享作用域初始化
  let initialized = false;
  let shareScope = {};

  const initializeSharing = async (scope) => {
    if (initialized) return;
    
    // 将当前应用的共享依赖注册到共享作用域
    for (const [name, versions] of Object.entries(sharedConfig)) {
      if (!scope[name]) {
        scope[name] = {};
      }
      
      for (const [version, config] of Object.entries(versions)) {
        if (!scope[name][version] || shouldUseVersion(scope[name][version], config)) {
          scope[name][version] = config;
        }
      }
    }
    
    shareScope = scope;
    initialized = true;
  };

  // 版本选择逻辑
  const shouldUseVersion = (existing, candidate) => {
    // 如果是singleton，选择更高版本
    if (candidate.singleton) {
      return compareVersions(candidate.version, existing.version) > 0;
    }
    return false;
  };

  // 版本比较函数
  const compareVersions = (v1, v2) => {
    const parts1 = v1.split('.').map(Number);
    const parts2 = v2.split('.').map(Number);
    
    for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
      const part1 = parts1[i] || 0;
      const part2 = parts2[i] || 0;
      
      if (part1 > part2) return 1;
      if (part1 < part2) return -1;
    }
    return 0;
  };

  // 远程容器对象
  const container = {
    // 初始化方法
    init: async (scope) => {
      return initializeSharing(scope);
    },
    
    // 获取模块方法
    get: async (module) => {
      if (!moduleMap[module]) {
        throw new Error(`Module "${module}" not found in componentLibraryA`);
      }
      
      // 确保共享依赖已加载
      await ensureSharedDependencies();
      
      // 返回模块加载函数
      return moduleMap[module];
    }
  };

  // 确保共享依赖加载
  const ensureSharedDependencies = async () => {
    const promises = [];
    
    for (const [name, versions] of Object.entries(shareScope)) {
      for (const [version, config] of Object.entries(versions)) {
        if (!config.loaded) {
          promises.push(config.get().then(() => {
            config.loaded = 1;
          }));
        }
      }
    }
    
    await Promise.all(promises);
  };

  // 注册到全局
  window.componentLibraryA = container;
})();
```
### 使用组件的应用
#### 配置
```js
// project-b/vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import federation from '@originjs/vite-plugin-federation'

export default defineConfig({
  plugins: [
    vue(),
    federation({
      // 主应用名称
      name: 'hostApp',
      // 远程应用配置
      remotes: {
        // 键名: 远程入口URL
        'componentLibraryA': 'http://localhost:3001/remoteEntry.js',
        // 如果有多个远程应用
        // 'anotherRemote': 'http://localhost:3002/remoteEntry.js'
      },
      // 共享依赖配置 - 必须与远程应用保持一致！
      shared: {
        'vue': {
          singleton: true,
          strictVersion: true,
          requiredVersion: '^3.3.0',
          eager: true  // 主应用设置为eager，优先加载
        },
        'element-plus': {
          singleton: true,
          requiredVersion: '^2.4.0',
          eager: true
        },
        'axios': {
          singleton: true,
          requiredVersion: '^1.5.0',
          eager: true
        }
      }
    })
  ],
  build: {
    target: 'esnext',
    rollupOptions: {
      // 主应用不需要外部化，因为它提供共享依赖
    }
  },
  server: {
    port: 3000
  }
})
```
#### vue
```vue
<!-- project-b/src/App.vue -->
<template>
  <div id="app">
    <h1>主应用 - 项目B</h1>
    
    <!-- 使用远程组件 -->
    <div class="remote-components">
      <h2>远程组件演示</h2>
      
      <Suspense>
        <template #default>
          <!-- 远程按钮组件 -->
          <RemoteButton 
            type="primary" 
            size="large"
            @click="handleRemoteButtonClick"
          >
            远程按钮
          </RemoteButton>
          
          <!-- 远程表格组件 -->
          <RemoteTable :data="tableData" />
          
          <!-- 远程表单组件 -->
          <RemoteForm @submit="handleFormSubmit" />
        </template>
        
        <template #fallback>
          <div class="loading">
            🔄 正在加载远程组件...
          </div>
        </template>
      </Suspense>
    </div>
  </div>
</template>

<script setup lang="ts">
import { defineAsyncComponent, ref, onMounted } from 'vue'

// 定义远程组件
const RemoteButton = defineAsyncComponent(() => 
  import('componentLibraryA/Button')
)

const RemoteTable = defineAsyncComponent(() => 
  import('componentLibraryA/Table')
)

const RemoteForm = defineAsyncComponent(() => 
  import('componentLibraryA/Form')
)

// 本地状态
const tableData = ref([
  { id: 1, name: '张三', age: 25 },
  { id: 2, name: '李四', age: 30 }
])

// 事件处理
const handleRemoteButtonClick = () => {
  console.log('远程按钮被点击了！')
}

const handleFormSubmit = (formData: any) => {
  console.log('远程表单提交:', formData)
}

// 组件挂载时的依赖检查
onMounted(async () => {
  console.log('🚀 主应用启动')
  
  // 检查共享依赖状态
  const vue = await import('vue')
  const elementPlus = await import('element-plus')
  
  console.log('📦 共享依赖加载状态:')
  console.log('- Vue版本:', vue.version)
  console.log('- Element Plus版本:', elementPlus.version)
})
</script>
```
## esm+import maps
最轻量化的方案，通过现代浏览器支持的 esm 和 import maps, 
import maps 将远程组件的依赖引入映射到对应的地址中，应用再通过 alias 将本地依赖也引用同样的地址，实现远程与本地使用相同的依赖
因为本地项目引入的 vue 会被打包器编译，编译过程中优先使用本地依赖，除非路径映射
### html
```html
<!doctype html>  
<html lang="">  
	<head>
		<meta charset="UTF-8" />  
		<link rel="icon" href="/favicon.ico" />  
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />  
		<title><%= title %></title>  
		<script src="/config/resourceConfig.js"></script>  
		<script type="importmap">  
			  {  
				"imports":{  
				  "vue":"https://unpkg.com/vue@3.5.13/dist/vue.esm-browser.js",  
				  "@moluoxixi/draggabletable":"http://localhost:98/components/DraggableTable/es/index.mjs",  
				  "@moluoxixi/daterangepicker":"http://localhost:98/components/DateRangePicker/es/index.mjs",  
				  "@moluoxixi/select":"http://localhost:98/components/Select/es/index.mjs"  
				}  
			  }  
		</script>  
	</head>
    <body>
        <div id="app"></div>  
        <script type="module" src="/src/main.ts"></script>  
    </body>
  </html>
```
### 
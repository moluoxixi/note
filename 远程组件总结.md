# è¿œç¨‹ç»„ä»¶æ–¹æ¡ˆåˆ†æ
## æ¨¡å—è”é‚¦
å·ç§°æœ€æˆç†Ÿçš„æ–¹æ¡ˆï¼ŒæŒ‰è¿œç¨‹åº”ç”¨çš„åå­—å¾€ window æ³¨å…¥å¯¹è±¡ï¼Œå¯¹è±¡é‡ŒåŒ…å«ä¾èµ–å’Œç»„ä»¶
åº”ç”¨ä½¿ç”¨è¿™ä¸ªå¯¹è±¡é‡Œçš„ä¾èµ–å’Œç»„ä»¶
### ç»„ä»¶åº”ç”¨
#### é…ç½®
```js
// project-a/vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import federation from '@originjs/vite-plugin-federation'

export default defineConfig({
Â  plugins: [
Â  Â  vue(),
Â  Â  federation({
Â  Â  Â  // è¿œç¨‹åº”ç”¨åç§°
Â  Â  Â  name: 'componentLibraryA',
Â  Â  Â  // ç”Ÿæˆçš„å…¥å£æ–‡ä»¶å
Â  Â  Â  filename: 'remoteEntry.js',
Â  Â  Â  // æš´éœ²çš„æ¨¡å—
Â  Â  Â  exposes: {
Â  Â  Â  Â  './Button': './src/components/Button/index.vue',
Â  Â  Â  Â  './Table': './src/components/Table/index.vue',
Â  Â  Â  Â  './Form': './src/components/Form/index.vue',
Â  Â  Â  Â  // ä¹Ÿå¯ä»¥æš´éœ²å·¥å…·å‡½æ•°
Â  Â  Â  Â  './utils': './src/utils/index.ts'
Â  Â  Â  },
Â  Â  Â  // å…±äº«ä¾èµ–é…ç½® - è¿™æ˜¯å…³é”®ï¼
Â  Â  Â  shared: {
Â  Â  Â  Â  'vue': {
Â  Â  Â  Â  Â  // å•ä¾‹æ¨¡å¼ï¼Œç¡®ä¿åªæœ‰ä¸€ä¸ªVueå®ä¾‹
Â  Â  Â  Â  Â  singleton: true,
Â  Â  Â  Â  Â  // ä¸¥æ ¼ç‰ˆæœ¬è¦æ±‚
Â  Â  Â  Â  Â  strictVersion: true,
Â  Â  Â  Â  Â  // å¿…éœ€çš„ç‰ˆæœ¬
Â  Â  Â  Â  Â  requiredVersion: '^3.3.0',
Â  Â  Â  Â  Â  // æ¸´æœ›åŠ è½½(ä¼˜å…ˆä½¿ç”¨å…±äº«ç‰ˆæœ¬)
Â  Â  Â  Â  Â  eager: false
Â  Â  Â  Â  },
Â  Â  Â  Â  'element-plus': {
Â  Â  Â  Â  Â  singleton: true,
Â  Â  Â  Â  Â  requiredVersion: '^2.4.0',
Â  Â  Â  Â  Â  eager: false
Â  Â  Â  Â  },
Â  Â  Â  Â  'axios': {
Â  Â  Â  Â  Â  singleton: true,
Â  Â  Â  Â  Â  requiredVersion: '^1.5.0',
Â  Â  Â  Â  Â  eager: false
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  })
Â  ],

Â  build: {
Â  Â  // ç›®æ ‡ESç‰ˆæœ¬
Â  Â  target: 'esnext',
Â  Â  // ä¸å‹ç¼©ï¼Œä¾¿äºè°ƒè¯•
Â  Â  minify: false,
Â  Â  rollupOptions: {
Â  Â  Â  // å¤–éƒ¨åŒ–å…±äº«ä¾èµ–
Â  Â  Â  external: ['vue', 'element-plus', 'axios'],
Â  Â  Â  output: {
Â  Â  Â  Â  // è¾“å‡ºæ ¼å¼
Â  Â  Â  Â  format: 'esm',
Â  Â  Â  Â  // å…¨å±€å˜é‡æ˜ å°„
Â  Â  Â  Â  globals: {
Â  Â  Â  Â  Â  'vue': 'Vue',
Â  Â  Â  Â  Â  'element-plus': 'ElementPlus',
Â  Â  Â  Â  Â  'axios': 'axios'
Â  Â  Â  Â  }
Â  Â  Â  }
Â  Â  }
Â  },
Â  // å¼€å‘æœåŠ¡å™¨é…ç½®
Â  server: {
Â  Â  port: 3001,
Â  Â  cors: true
Â  }
})
```
#### äº§ç‰©ç¤ºä¾‹
```js
// dist/remoteEntry.js
(function() {
  'use strict';

  // æ¨¡å—æ˜ å°„è¡¨ - æ¯ä¸ªæš´éœ²çš„æ¨¡å—éƒ½æœ‰å¯¹åº”çš„åŠ è½½å‡½æ•°
  const moduleMap = {
    './Button': () => {
      return import('./assets/Button-a1b2c3d4.js');
    },
    './Table': () => {
      return import('./assets/Table-e5f6g7h8.js');
    },
    './Form': () => {
      return import('./assets/Form-i9j0k1l2.js');
    },
    './utils': () => {
      return import('./assets/utils-m3n4o5p6.js');
    }
  };

  // å…±äº«ä¾èµ–é…ç½®
  const sharedConfig = {
    'vue': {
      '3.3.4': {
        get: () => import('./shared/vue-shared-chunk.js'),
        loaded: 1,
        eager: false,
        singleton: true
      }
    },
    'element-plus': {
      '2.4.0': {
        get: () => import('./shared/element-plus-shared-chunk.js'),
        loaded: 1,
        eager: false,
        singleton: true
      }
    },
    'axios': {
      '1.5.0': {
        get: () => import('./shared/axios-shared-chunk.js'),
        loaded: 1,
        eager: false,
        singleton: true
      }
    }
  };

  // å…±äº«ä½œç”¨åŸŸåˆå§‹åŒ–
  let initialized = false;
  let shareScope = {};

  const initializeSharing = async (scope) => {
    if (initialized) return;
    
    // å°†å½“å‰åº”ç”¨çš„å…±äº«ä¾èµ–æ³¨å†Œåˆ°å…±äº«ä½œç”¨åŸŸ
    for (const [name, versions] of Object.entries(sharedConfig)) {
      if (!scope[name]) {
        scope[name] = {};
      }
      
      for (const [version, config] of Object.entries(versions)) {
        if (!scope[name][version] || shouldUseVersion(scope[name][version], config)) {
          scope[name][version] = config;
        }
      }
    }
    
    shareScope = scope;
    initialized = true;
  };

  // ç‰ˆæœ¬é€‰æ‹©é€»è¾‘
  const shouldUseVersion = (existing, candidate) => {
    // å¦‚æœæ˜¯singletonï¼Œé€‰æ‹©æ›´é«˜ç‰ˆæœ¬
    if (candidate.singleton) {
      return compareVersions(candidate.version, existing.version) > 0;
    }
    return false;
  };

  // ç‰ˆæœ¬æ¯”è¾ƒå‡½æ•°
  const compareVersions = (v1, v2) => {
    const parts1 = v1.split('.').map(Number);
    const parts2 = v2.split('.').map(Number);
    
    for (let i = 0; i < Math.max(parts1.length, parts2.length); i++) {
      const part1 = parts1[i] || 0;
      const part2 = parts2[i] || 0;
      
      if (part1 > part2) return 1;
      if (part1 < part2) return -1;
    }
    return 0;
  };

  // è¿œç¨‹å®¹å™¨å¯¹è±¡
  const container = {
    // åˆå§‹åŒ–æ–¹æ³•
    init: async (scope) => {
      return initializeSharing(scope);
    },
    
    // è·å–æ¨¡å—æ–¹æ³•
    get: async (module) => {
      if (!moduleMap[module]) {
        throw new Error(`Module "${module}" not found in componentLibraryA`);
      }
      
      // ç¡®ä¿å…±äº«ä¾èµ–å·²åŠ è½½
      await ensureSharedDependencies();
      
      // è¿”å›æ¨¡å—åŠ è½½å‡½æ•°
      return moduleMap[module];
    }
  };

  // ç¡®ä¿å…±äº«ä¾èµ–åŠ è½½
  const ensureSharedDependencies = async () => {
    const promises = [];
    
    for (const [name, versions] of Object.entries(shareScope)) {
      for (const [version, config] of Object.entries(versions)) {
        if (!config.loaded) {
          promises.push(config.get().then(() => {
            config.loaded = 1;
          }));
        }
      }
    }
    
    await Promise.all(promises);
  };

  // æ³¨å†Œåˆ°å…¨å±€
  window.componentLibraryA = container;
})();
```
### ä½¿ç”¨ç»„ä»¶çš„åº”ç”¨
#### é…ç½®
```js
// project-b/vite.config.ts
import { defineConfig } from 'vite'
import vue from '@vitejs/plugin-vue'
import federation from '@originjs/vite-plugin-federation'

export default defineConfig({
  plugins: [
    vue(),
    federation({
      // ä¸»åº”ç”¨åç§°
      name: 'hostApp',
      // è¿œç¨‹åº”ç”¨é…ç½®
      remotes: {
        // é”®å: è¿œç¨‹å…¥å£URL
        'componentLibraryA': 'http://localhost:3001/remoteEntry.js',
        // å¦‚æœæœ‰å¤šä¸ªè¿œç¨‹åº”ç”¨
        // 'anotherRemote': 'http://localhost:3002/remoteEntry.js'
      },
      // å…±äº«ä¾èµ–é…ç½® - å¿…é¡»ä¸è¿œç¨‹åº”ç”¨ä¿æŒä¸€è‡´ï¼
      shared: {
        'vue': {
          singleton: true,
          strictVersion: true,
          requiredVersion: '^3.3.0',
          eager: true  // ä¸»åº”ç”¨è®¾ç½®ä¸ºeagerï¼Œä¼˜å…ˆåŠ è½½
        },
        'element-plus': {
          singleton: true,
          requiredVersion: '^2.4.0',
          eager: true
        },
        'axios': {
          singleton: true,
          requiredVersion: '^1.5.0',
          eager: true
        }
      }
    })
  ],
  build: {
    target: 'esnext',
    rollupOptions: {
      // ä¸»åº”ç”¨ä¸éœ€è¦å¤–éƒ¨åŒ–ï¼Œå› ä¸ºå®ƒæä¾›å…±äº«ä¾èµ–
    }
  },
  server: {
    port: 3000
  }
})
```
#### vue
```vue
<!-- project-b/src/App.vue -->
<template>
  <div id="app">
    <h1>ä¸»åº”ç”¨ - é¡¹ç›®B</h1>
    
    <!-- ä½¿ç”¨è¿œç¨‹ç»„ä»¶ -->
    <div class="remote-components">
      <h2>è¿œç¨‹ç»„ä»¶æ¼”ç¤º</h2>
      
      <Suspense>
        <template #default>
          <!-- è¿œç¨‹æŒ‰é’®ç»„ä»¶ -->
          <RemoteButton 
            type="primary" 
            size="large"
            @click="handleRemoteButtonClick"
          >
            è¿œç¨‹æŒ‰é’®
          </RemoteButton>
          
          <!-- è¿œç¨‹è¡¨æ ¼ç»„ä»¶ -->
          <RemoteTable :data="tableData" />
          
          <!-- è¿œç¨‹è¡¨å•ç»„ä»¶ -->
          <RemoteForm @submit="handleFormSubmit" />
        </template>
        
        <template #fallback>
          <div class="loading">
            ğŸ”„ æ­£åœ¨åŠ è½½è¿œç¨‹ç»„ä»¶...
          </div>
        </template>
      </Suspense>
    </div>
  </div>
</template>

<script setup lang="ts">
import { defineAsyncComponent, ref, onMounted } from 'vue'

// å®šä¹‰è¿œç¨‹ç»„ä»¶
const RemoteButton = defineAsyncComponent(() => 
  import('componentLibraryA/Button')
)

const RemoteTable = defineAsyncComponent(() => 
  import('componentLibraryA/Table')
)

const RemoteForm = defineAsyncComponent(() => 
  import('componentLibraryA/Form')
)

// æœ¬åœ°çŠ¶æ€
const tableData = ref([
  { id: 1, name: 'å¼ ä¸‰', age: 25 },
  { id: 2, name: 'æå››', age: 30 }
])

// äº‹ä»¶å¤„ç†
const handleRemoteButtonClick = () => {
  console.log('è¿œç¨‹æŒ‰é’®è¢«ç‚¹å‡»äº†ï¼')
}

const handleFormSubmit = (formData: any) => {
  console.log('è¿œç¨‹è¡¨å•æäº¤:', formData)
}

// ç»„ä»¶æŒ‚è½½æ—¶çš„ä¾èµ–æ£€æŸ¥
onMounted(async () => {
  console.log('ğŸš€ ä¸»åº”ç”¨å¯åŠ¨')
  
  // æ£€æŸ¥å…±äº«ä¾èµ–çŠ¶æ€
  const vue = await import('vue')
  const elementPlus = await import('element-plus')
  
  console.log('ğŸ“¦ å…±äº«ä¾èµ–åŠ è½½çŠ¶æ€:')
  console.log('- Vueç‰ˆæœ¬:', vue.version)
  console.log('- Element Plusç‰ˆæœ¬:', elementPlus.version)
})
</script>
```
## esm+import maps
æœ€è½»é‡åŒ–çš„æ–¹æ¡ˆï¼Œé€šè¿‡ç°ä»£æµè§ˆå™¨æ”¯æŒçš„ esm å’Œ import maps, 
import maps å°†è¿œç¨‹ç»„ä»¶çš„ä¾èµ–å¼•å…¥æ˜ å°„åˆ°å¯¹åº”çš„åœ°å€ä¸­ï¼Œåº”ç”¨å†é€šè¿‡ alias å°†æœ¬åœ°ä¾èµ–ä¹Ÿå¼•ç”¨åŒæ ·çš„åœ°å€ï¼Œå®ç°è¿œç¨‹ä¸æœ¬åœ°ä½¿ç”¨ç›¸åŒçš„ä¾èµ–
å› ä¸ºæœ¬åœ°é¡¹ç›®å¼•å…¥çš„ vue ä¼šè¢«æ‰“åŒ…å™¨ç¼–è¯‘ï¼Œç¼–è¯‘è¿‡ç¨‹ä¸­ä¼˜å…ˆä½¿ç”¨æœ¬åœ°ä¾èµ–ï¼Œé™¤éè·¯å¾„æ˜ å°„
### html
```html
<!doctype html>  
<html lang="">  
	<head>
		<meta charset="UTF-8" />  
		<link rel="icon" href="/favicon.ico" />  
		<meta name="viewport" content="width=device-width, initial-scale=1.0" />  
		<title><%= title %></title>  
		<script src="/config/resourceConfig.js"></script>  
		<script type="importmap">  
			  {  
				"imports":{  
				  "vue":"https://unpkg.com/vue@3.5.13/dist/vue.esm-browser.js",  
				  "@moluoxixi/draggabletable":"http://localhost:98/components/DraggableTable/es/index.mjs",  
				  "@moluoxixi/daterangepicker":"http://localhost:98/components/DateRangePicker/es/index.mjs",  
				  "@moluoxixi/select":"http://localhost:98/components/Select/es/index.mjs"  
				}  
			  }  
		</script>  
	</head>
    <body>
        <div id="app"></div>  
        <script type="module" src="/src/main.ts"></script>  
    </body>
  </html>
```
### 